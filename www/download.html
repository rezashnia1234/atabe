<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1" />
    <title>بسم الله الرحمن الرحيم</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/progress.bar.css">

    <link rel="stylesheet" type="text/css" href="css/template.css">

	<script src="js/jquery-2.2.2.min.js"></script>
    <script src="phonegap.js"></script>
    <script src="js/fastclick.js"></script>
    <script src="js/hammer.min.js"></script>
	<script src="js/console.log.js"></script>

	<script>
		function init() {		
			console.log('SMGROUP ::::::::::::::::::::::::::::::::::::    start init()');
			document.addEventListener("deviceready", onDeviceReady, false);
			/**** added by mahdi *********/
			if(isRetina())
			{
				$('.retina').each( function(i) {
					var back = $(this).css('background-image');
					back = back.replace("/low", "/high");
					$(this).css('background-image',back);
				});
				$('.retina:before').each( function(i) {
					var back = $(this).css('background-image');
					back = back.replace("/low", "/high");
					$(this).css('background-image',back);
				});
			}

		}


		function onDeviceReady() {
		
			var networkState = navigator.connection.type;

			FastClick.attach(document.body);
			//if ( device.platform == 'Android' ){//Android,iOS,win7=WinCE,win8=Win32NT
			//	document.addEventListener("backbutton", go_back, false);
			//}
			
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
/////START DOWNLOAD//////////////////////////////////////////////////////////////////////
/*
		$('.play_it').each( function(i) {
			//$(this).css("display","none");
			var temp_array = JSON.parse(window.localStorage.getItem('downloaded_files'));
			if($.inArray($.md5($(this).attr('online')),temp_array) != -1)
			{
				$(this).removeClass("need_download").addClass("downloaded");
			}
		});
		$('.play_it').click( function(i) {
			temp_element = $(this);
			//alert($(this).attr('online'));
			
			//play_or_download('http://khamenei.mobi/app/jh/ios/audio/roze/02.mp3','mp3');
			play_or_download($(this).attr('online'),"mp3");
		});
*/		
		
		
		
		if(window.localStorage.getItem('downloaded_files') == null){
			window.localStorage.setItem('downloaded_files',JSON.stringify(["786","110"]));	
		}
		
		
		if(window.localStorage.getItem('download_address') == null){
			
			window.requestFileSystem(LocalFileSystem.TEMPORARY, 0, 
				function(fs) {
					window.localStorage.setItem('download_address',fs.root.toURL());
				}, function(e) {
					alert('failed to get fs');
					alert(JSON.stringify(e));
				}
			);
		}

		console.log("window.localStorage.getItem('download_address'):" + window.localStorage.getItem('download_address'));
		console.log("window.localStorage.getItem('downloaded_files'):" + window.localStorage.getItem('downloaded_files'));
		
		play_or_download('http://smcms.ir/tmp/panos.zip','zip');

	}
	
	function play_or_download(URL,Extension) {
		console.log("play_or_download URL: " + URL);
		console.log("play_or_download Extension: " + Extension);

		if (device.platform == 'iOS')
		{
			downloadPath = "cdvfile://localhost/persistent/";
			window.localStorage.setItem('download_address',downloadPath);
		}
		
		downloadPath = window.localStorage.getItem('download_address') + $.md5(URL) + "." + Extension;
		console.log("play_or_download : " + downloadPath);
		if(check_download(URL))
		{
			console.log("play_or_download : check_download");
			
			//$("#play").css("display","none");
			//playAudio_new(downloadPath,true);
			alert("it is already downloaded!");
			//var media = new Media(downloadPath, null, function(e) { alert(JSON.stringify(e));});
			//media.play();
		}
		else
		{
			console.log("play_or_download : start_download");
			start_download(URL,Extension);
		}
	}

	function start_download(URL,Extension) {
		console.log("start_download check internet");
		networkState = navigator.connection.type;
		if (networkState == Connection.NONE) {
			console.log("start_download : NO internet");
			navigator.notification.alert(
				'شما برای اینکار به اینترنت نیاز دارید',  // message
				temp_function,         // callback
				'اخطار',            // title
				'تائید'                  // buttonName
			);
		}
		else{
			console.log("start_download : we have internet");

			console.log("start_download URL: " + URL);
			console.log("start_download Extension: " + Extension);
			
			var FileTransfer_OBJ = new FileTransfer();
			var uri = encodeURI(URL + "?" + Math.random());
			
			if (device.platform == 'iOS')
			{
				downloadPath = "cdvfile://localhost/persistent/";
				window.localStorage.setItem('download_address',downloadPath);
			}
			
			$('.progress-bar-parent').css("display","block");
			
			downloadPath = window.localStorage.getItem('download_address') + $.md5(URL) + "." + Extension;
			console.log("start_download : " + downloadPath);
			
			FileTransfer_OBJ.onprogress = function(progressEvent) {
				if (progressEvent.lengthComputable) {
					var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
					$('#status').html(perc + "%");
					$('.progress-bar-percent').css('width',perc + "%");
					//progress_bar_element.css('width',perc);
				} else {
					$('#status').html($('#status').html() + ".");
					//progress_bar_element.css('width',progress_bar_element.width()+1);
					$('.progress-bar-percent').css('width',$('.progress-bar-parent').find('span').width()+1);
				}
			};
			
			FileTransfer_OBJ.download(uri, downloadPath, 
				function(entry) {	
					$('#status').html("");
					$('.progress-bar-parent').find('span').css('width','2%');
					console.log("start_download : done");
					temp_array = JSON.parse(window.localStorage.getItem('downloaded_files'));
					temp_array.push($.md5(URL));
					window.localStorage.setItem('downloaded_files',JSON.stringify(temp_array));	
					
					//temp_element.removeClass("need_download");
					//$("#play").css("display","none");
					$('.progress-bar-parent').css("display","none");				
				}, 
				function(error) {
					//alert('Crap something went wrong...');	
					//alert(JSON.stringify(error));
					navigator.notification.alert(
						'خطا در دانلود فایل',  // message
						temp_function,         // callback
						'اخطار',            // title
						'تائید'                  // buttonName
					);
					$('.progress-bar-parent').find('span').css('width','2%');
					$('.progress-bar-percent').css('width',"");
					$('.progress-bar-parent').css("display","none");
				},
				true
			);
			
			$("#abort").click( function(i) {
				FileTransfer_OBJ.abort();
				$('.progress-bar-parent').find('span').css('width','2%');
				$('.progress-bar-percent').css('width',"");
				$('.progress-bar-parent').css("display","none");
				alert("download canceld");
			});
			
			
			
		}
	}
	
	function check_download(URL) {
		console.log("check_download URL: " + URL);
		var temp_array = JSON.parse(window.localStorage.getItem('downloaded_files'));
		console.log("check_download Extension: " + window.localStorage.getItem('downloaded_files'));
		if($.inArray($.md5(URL),temp_array) != -1)
		{
			console.log("check_download true");
			return true;
		}
		else
		{
			console.log("check_download false");
			return false;
		}
	}

/////END DOWNLOAD////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
			
			
			
			
			

		$(window).load(function() {		
			setTimeout(function(){
				$(".mypreload").html("");
			}, 300);
		});


		function isHighDensity(){
			return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) || (window.devicePixelRatio && window.devicePixelRatio > 1.3));
		}
		function isRetina(){
			return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx), only screen and (min-resolution: 75.6dpcm)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min--moz-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2)').matches)) || (window.devicePixelRatio && window.devicePixelRatio >= 2)) && /(iPad|iPhone|iPod)/g.test(navigator.userAgent);
		}
		$(document).ready(function(){

		});
	</script>	

		
		
		
<style>


</style>	
</head>
<!--http://smcms.ir/tmp/panos.zip-->
<body onload="init();" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" id="body" class="smm_ziarat_body retina">
	<div class="bg retina" ></div>
	<div class="progress-bar-parent">
		<div class="progress-bar green glow">
			<div id="status"></div>
			<span class="progress-bar-percent" style="width: 2%"></span>
			<div id="descripion">
				<div class="first">التحمیل</div> <div class="hajm">50<div></div>mb</div>
			</div>
			<div id="abort_box"><input type="button" id="abort" value="إلغاء" /></div>
		</div>
	</div>

</body>
</html>