<!DOCTYPE html>
<html>
<head>
<title>بسم الله الرحمن الرحیم</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" type="text/css" href="css/reset.css">
<link rel="stylesheet" type="text/css" href="css/font.css">

<link rel="stylesheet" href="maps/js/leaflet.css" />
<link rel="stylesheet" href="maps/js/leaflet-search.css" />
<link rel="stylesheet" href="maps/js/leaflet-routing-machine.css" />
<link rel="stylesheet" href="maps/js/style.css" />
</head>

<body onload="init();">
	<div id="favorites_btn" class="top_left_smcms_btn" ></div>
	<div id="wifi_btn" class="top_left_smcms_btn" ></div>
	<div id="routing_btn" class="top_left_smcms_btn" ></div>
	<div id="map"></div>

	<div class="cd-popup is-visible0" role="alert">
		<div class="cd-popup-container">
			<p><input id="favorite_title" id="favorite_title" placeholder="عنوان نقطه جدید" /></p>
			<ul class="cd-buttons">
				<li><a href="#" onclick="add_to_favorites();">تاید</a></li>
				<li><a href="#" onclick="add_to_favorites_open();">لغو</a></li>
			</ul>
			<!--<a href="#0" class="cd-popup-close img-replace">Close</a>-->
		</div> <!-- cd-popup-container -->
	</div> <!-- cd-popup -->

<script src="js/jquery-3.0.0.min.js"></script>
<script src="maps/js/leaflet-src.js"></script>
<script src="maps/js/leaflet-search.js"></script>
<script src="maps/js/leaflet-routing-machine.min.js"></script> 
<script src="maps/js/Control.Geocoder.js"></script>

<script src="maps/js/fuse.min.js"></script>
<script src="maps/js/points.json"></script>
<script>
	var my_location_gps;
	new_favorite_marker = "";
	add_to_favorites_popup = false;
	
	function init() {		
		console.log('SMGROUP ::::::::::::::::::::::::::::::::::::    start init()');
		document.addEventListener("deviceready", onDeviceReady, false);
		
		radius = 0;


		my_location_marker = L.marker([36.2879,59.6157], {icon: user_location_icon,zIndexOffset: 999}).addTo(map);
		my_location_circle = L.circle([36.2879,59.6157], radius).addTo(map);
	}
	
	function onDeviceReady() {
		//FastClick.attach(document.getElementById('button'));
		/*
		(function(){
			navigator.geolocation.getCurrentPosition(onSuccess, onError);
			setTimeout(arguments.callee, 5000);
		})();
		*/
	}
	
	var categories = {
		101 : {desc: "اماکن المقدسة", icon:"zearati"},/////////////
		102 : {desc: "الأماكن المفضلة ", icon:"fav"},
		103 : {desc: "مراكز صحية", icon:"hospetal"},///////////////////////////////
		104 : {desc: "استراحات الزائرين", icon:"mukeb"},
		105 : {desc: "نقاط التفتيش", icon:"stop"},
		106 : {desc: "فنادق", icon:"hotel"},///////////////////////////////
		107 : {desc: "اعمدة", icon:"mil"},//////////////////////////////////
		108 : {desc: "محطات النقل", icon:"hamlonaghl"},/////////////////////////////
		109 : {desc: "مراكز المفقودين", icon:"gomshodeghan"},
		110 : {desc: "القنصليات", icon:"edari"},
		111 : {desc: "خدمات الزائرين", icon:"service"},
	};
	
	
		
	var icon_style_favorites_new = L.Icon.extend({
		options: {
			iconSize:     [25, 41], // size of the icon
			iconAnchor:   [12,41], // point of the icon which will correspond to marker's location
			popupAnchor:  [0, -41], // point from which the popup should open relative to the iconAnchor
			shadowSize:   [41, 41],
			shadowAnchor: [11, 39]
		}
	});
	var icon_style_user_location = L.Icon.extend({
		options: {
			iconSize:     [44, 59], // size of the icon
			iconAnchor:   [22,59], // point of the icon which will correspond to marker's location
			popupAnchor:  [0, -59] // point from which the popup should open relative to the iconAnchor
		}
	});
	var	user_location_icon	= new icon_style_user_location({iconUrl: 'maps/map-icon/user_location.png',iconRetinaUrl: 'maps/map-icon/user_location@2x.png',});
	
	var setupIcons = function() {

		var icons = {};
		for (var cat in categories) {
			var icon = categories[cat].icon;
			//console.log(icon);
			/**/
			var url = "maps/map-icon/" + icon;
	 
			var icon = L.icon({
				iconUrl:		url + '.png',
				iconRetinaUrl:	url + '@2x.png',
				iconSize:		[33, 44],
				iconAnchor:		[16,44],
				popupAnchor:	[0, -44]
			});
			
			icons[cat] = icon;
		}
		
		return icons;
	};
	var icons = setupIcons();




	var offline_map = L.tileLayer('maps/mapquest/{z}/{x}/{y}.png', {maxZoom: 16}),
		online_map  = L.tileLayer('http://imamali.net/app-json/map/{z}/{x}/{y}.png', {maxZoom: 18});
		
	var map = L.map('map', {
		zoom: 14,
		maxZoom: 16,//17
		minZoom:1,
		center: new L.latLng(32.0192,44.3298),
		layers: online_map,//L.tileLayer('maps/mapquest/{z}/{x}/{y}.png'),
		zoomControl:false
	});


		
		
	// Layer control, setting up 1 layer per category
	var layers = {},
		cultureLayer = L.layerGroup(),
		layerCtrl = L.control.layers();
	for (var icat in categories) {
		var layer = L.featureGroup();
		layers[icat] = layer;
		cultureLayer.addLayer(layer);
		
		//var cat = categories[icat],desc = '<img class="layer-control-img ' + cat.icon + '" src="maps/map-icon/' + cat.icon + '@2x.png"> ' + cat.desc;
		var cat = categories[icat],desc = cat.desc;
		layerCtrl.addOverlay(layer, desc);
	}
	//cultureLayer.addTo(map);

/**/
	var restLayers = L.geoJson(restaurant500, {
		pointToLayer: function(feature, latlng) {
			var cat = feature.properties.categorie;
			var icon = icons[cat];
			
			var props = L.Util.extend({
						'name': '',
						'cuisine': '',
						'website': '',
						'phone': ''
					},feature.properties),
				textPopup = L.Util.template("<h3>{name}</h3>", props),
				style = {
					radius: 5,
					opacity: 0.8,
					fillColor: '#ddd',
					fillOpacity: 0.8
				};

			//return L.circleMarker(latlng, style).bindPopup(textPopup);
			/**/
			var my_marker = L.marker(latlng, {icon: icon,keyboard: false,riseOnHover: true}).bindPopup(textPopup);
			layerwww = layers[cat];
			if (layerwww !== undefined) {
				//console.log(layerwww);
				layerwww.addLayer(my_marker);
			}
			return my_marker;
			
		}
	});
	//restLayers.addTo(map);



		
		
	var fuse = new Fuse(restaurant500.features, {
		keys: ['properties.name']
	});

	L.control.search({
		layer: restLayers,
		propertyName: 'name',
		textErr: 'موقعیت یافت نشد',	//error message
		textCancel: 'لغو',		    //title in cancel button		
		textPlaceholder: 'جستجو در میان نقاط...',   //placeholder value		 // 'جستجو در میان نقاط...'
		markerLocation: true,
		filterData: function(text, records) {
			var jsons = fuse.search(text),
				ret = {}, key;
			
			for(var i in jsons) {
				//jsons[i].properties.name = jsons[i].properties.name + " - 000";
				key = jsons[i].properties.name;
				ret[ key ]= records[key];
			}

			//console.log(jsons,ret);
			return ret;
		}
	})
	.on('search_locationfound', function(e) {
		e.layer.openPopup();
	}).addTo(map);

	layerCtrl.setPosition('topleft');
	layerCtrl.addTo(map);
	
	
	L.control.scale({'position':'bottomleft'}).addTo(map);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	var customControl =  L.Control.extend({
		options: {
			position: 'topleft'
		},
		onAdd: function (map) {
			var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-back_btn');

			container.style.backgroundColor = 'white';     
			container.style.backgroundImage = "url('maps/images/back.png')";
			container.style.backgroundSize = "30px 30px";
			container.style.width = '30px';
			container.style.height = '30px';

			container.onclick = function(){
				//console.log('buttonClicked');
				window.location.href = 'map.html';
			}

			return container;
		}
	});
	map.addControl(new customControl());
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	

	
	setTimeout(function(){
		$('.leaflet-control-layers-list .leaflet-control-layers-overlays .leaflet-control-layers-selector').slice(2).prop('checked', true);
		//$('.leaflet-control-layers-list .leaflet-control-layers-overlays .leaflet-control-layers-selector:not(:first)').prop('checked', true);
		//$('.leaflet-control-layers-list .leaflet-control-layers-overlays .layer-control-img.zearati').parent().parent().find('input[type=checkbox]').prop('checked', false);
		//$('.leaflet-control-layers-list .leaflet-control-layers-overlays .layer-control-img.fav').parent().parent().find('input[type=checkbox]').prop('checked', false);
		//$('.leaflet-control-layers-list .leaflet-control-layers-overlays .layer-control-img.hospetal').parent().parent().find('input[type=checkbox]').prop('checked', false);
		$('.leaflet-control-layers-list .leaflet-control-layers-overlays .leaflet-control-layers-selector').trigger('click');
		
		
	}, 1000);
	

	
	
	
	function route_function(point1th_lat,point1th_long,point2th_lat,point2th_long) {
		/*** start routing ***/
		/**/
		L.Routing.control({
		  waypoints: [
			L.latLng(point1th_lat,point1th_long),
			L.latLng(point2th_lat,point2th_long)
		  ],
			routeWhileDragging: true,
			reverseWaypoints: false,
			showAlternatives: true,
			geocoder: L.Control.Geocoder.nominatim(),
			language: "fa",
			position:'bottomleft'
		}).addTo(map);
		
	}
	
	(function($) {
		$.fn.clickToggle = function(func1, func2) {
			var funcs = [func1, func2];
			this.data('toggleclicked', 0);
			this.click(function() {
				var data = $(this).data();
				var tc = data.toggleclicked;
				$.proxy(funcs[tc], this)();
				data.toggleclicked = (tc + 1) % 2;
			});
			return this;
		};
	}(jQuery));
	
	$(document).ready(function(){
		$("#routing_btn").click(function(){
			route_function(31.99564047,44.31262563,32.6171,44.0362);
		});
		
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
		function add_to_favorites_open() {
			if(add_to_favorites_popup==false)
			{
				new_favorite_marker = L.marker(map.getCenter() ).addTo(map);
								
				map.on('move', function () {
					new_favorite_marker.setLatLng(map.getCenter());
					//console.log(map.getCenter());
				});
			
				$("#add_to_favorites").addClass("disabled");
				$(".cd-popup").addClass("is-visible");
				add_to_favorites_popup = true;
				//new_favorite_marker_icon	= new icon_style_favorites_new({iconUrl: 'maps/map-icon/marker-icon.png',iconRetinaUrl: 'maps/map-icon/marker-icon@2x.png',shadowUrl: 'maps/map-icon/marker-shadow.png',});
				//new_favorite_marker = L.marker(map.getCenter(), {icon: new_favorite_marker_icon,setZIndexOffset: 1000,draggable:true}).addTo(map).bindPopup("لطفا این مارکر را در موقعیت دلخواه قرار دهید.").openPopup();
			}
			else
			{
				$("#add_to_favorites").removeClass("disabled");
				$(".cd-popup").removeClass("is-visible");
				add_to_favorites_popup = false;
				map.removeLayer(new_favorite_marker);
			}
		}
		
		$("#favorites_btn").click(function(){
			add_to_favorites_open()

		});
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
		function change_map_online_function() {
			map.removeLayer(offline_map);
			map.addLayer(online_map);
			map.options.maxZoom = 18;
		}
		function change_map_offline_function() {
			map.removeLayer(online_map);
			map.addLayer(offline_map);
			map.options.maxZoom = 16;
		}
		$("#wifi_btn").clickToggle(change_map_online_function,change_map_offline_function);
	});
</script>
<style>


</style>


</body>
</html>
